import pandas as pd  
import re 

from selenium import webdriver 
from bs4 import BeautifulSoup
from lmf.dbv2 import db_write
from selenium.webdriver.common.keys import Keys 
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException,StaleElementReferenceException
from selenium.common.exceptions import WebDriverException
from selenium.webdriver.support.wait import WebDriverWait 
from selenium.webdriver.support import expected_conditions as EC 

import json

import time

from zhulong.util.etl import est_html,est_meta 
_name_="zhanjiang"


def f1(driver,num):
    locator=(By.CLASS_NAME,"mmggxlh")
    WebDriverWait(driver,10).until(EC.presence_of_element_located(locator))

    locator=(By.XPATH,"//div[@class='mmggxlh']//span[contains(string(),'当前第')]")
    WebDriverWait(driver,10).until(EC.presence_of_element_located(locator))
    cnum=int(re.findall("当前第([0-9]{1,})页" ,driver.find_element_by_xpath("//div[@class='mmggxlh']//span[contains(string(),'当前第')]").text)[0])

    if num!=cnum:
        val=driver.find_element_by_xpath("//table[@id='datagrid']//tr[2]//a").text

        locator=(By.XPATH,"//div[@class='gcxxfy']//input[@class='mmggkuan']")
        WebDriverWait(driver,10).until(EC.presence_of_element_located(locator))
        input1=driver.find_element_by_xpath("//div[@class='gcxxfy']//input[@class='mmggkuan']")
        input1.clear()
        input1.send_keys(num)
        locator=(By.XPATH,"//div[@class='gcxxfy']//a[@data-bind='click: jump']")
        WebDriverWait(driver,10).until(EC.presence_of_element_located(locator))
        driver.find_element_by_xpath("//div[@class='gcxxfy']//a[@data-bind='click: jump']").click()

        locator=(By.XPATH,"//table[@id='datagrid']//tr[2]//a[string()!='%s']"%val)
        WebDriverWait(driver,10).until(EC.presence_of_element_located(locator))


    page=driver.page_source 

    soup=BeautifulSoup(page,"lxml")

    table=soup.find("table",id="datagrid")

    trs=table.find_all("tr")
    data=[]
    for tr in trs[1:]:
        a=tr.find("a")
        ggstart_time=tr.find_all("td")[2].text.strip()
        name=a["title"]
        tmp=[name,ggstart_time]
        data.append(tmp)
    df=pd.DataFrame(data=data)
    df["info"]=None
    return df 


def f2(driver):
    locator=(By.ID,"datagrid")
    WebDriverWait(driver,10).until(EC.presence_of_element_located(locator))



    locator=(By.XPATH,"//div[@class='mmggxlh']//span[contains(string(),'当')]")
    WebDriverWait(driver,10).until(EC.presence_of_element_located(locator))
    total=int(re.findall("共([0-9]{1,})页" ,driver.find_element_by_xpath("//div[@class='mmggxlh']//span[@class='dian'][3]").text)[0])
    driver.quit()
    return total

def f3(driver,url):

    driver.get(url)

    locator=(By.CLASS_NAME,"xx_content")

    WebDriverWait(driver,10).until(EC.presence_of_all_elements_located(locator))

    before=len(driver.page_source)
    time.sleep(0.1)
    after=len(driver.page_source)
    i=0
    while before!=after:
        before=len(driver.page_source)
        time.sleep(0.1)
        after=len(driver.page_source)
        i+=1
        if i>5:break

    page=driver.page_source

    soup=BeautifulSoup(page,'lxml')

    div=soup.find('div',class_="xx_content")
    #div=div.find_all('div',class_='ewb-article')[0]
    
    return div


data=[
        ["gcjs_zhaobiao_gg","http://www.zjprtc.com/JSGC/ZBGGList.html?moduletype=5&subtype=1",["name","ggstart_time","info"],f1,f2],

        ["gcjs_zhongbiao_gg","http://www.zjprtc.com/JSGC/JSGC_PBJGGSList.html?moduletype=5&subtype=24",["name","ggstart_time","info"],f1,f2],

        ["gcjs_biangen_gg","http://www.zjprtc.com/JSGC/JSGC_GZGGList.html?moduletype=5&subtype=2",["name","ggstart_time","info"],f1,f2],


        ["zfcg_zhaobiao_gg","http://www.zjprtc.com/Jyweb/ZFCG_JYXTList.html?moduletype=5&subtype=12",["name","ggstart_time","info"],f1,f2],

        ["zfcg_biangen_gg","http://www.zjprtc.com/Jyweb/ZFCG_GengZhengGongGao_List.html?moduletype=5&subtype=13",["name","ggstart_time","info"],f1,f2],

        ["zfcg_zhongbiao_gg","http://www.zjprtc.com/Jyweb/ZFCG_PingBiaoJieGuo_List.html?moduletype=5&subtype=14",["name","ggstart_time","info"],f1,f2]



    ]



def work(conp,**args):
    est_meta(conp,data=data,diqu="广东省湛江市",**args)
    est_html(conp,f=f3,**args)


if __name__=='__main__':
    work(conp=["postgres","since2015","127.0.0.1","guangdong","zhanjiang"])