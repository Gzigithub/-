import re

import requests
from bs4 import BeautifulSoup
from lmfscrap import web
from lxml import etree
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import pandas as pd
from zhulong.util.etl import est_html, est_meta
import time

_name_='liaoyang'
def f1(driver, num):
    locator = (By.XPATH,"//li[@class='no-active']/a")
    WebDriverWait(driver,20).until(EC.presence_of_element_located(locator))
    page_temp = driver.find_element_by_xpath("//li[@class='no-active']/a").text
    cnum = re.findall("(\d+)\/",page_temp)[0]
    locator = (By.XPATH, "//ul[@id='info']/li")
    WebDriverWait(driver, 20).until(EC.visibility_of_all_elements_located(locator))
    val = driver.find_element_by_xpath("//ul[@id='info']/li[1]/div[@class='title']/a").text
    if int(cnum) != int(num):
        driver.find_element_by_xpath('//div[@id="jumpDiv"]/input').clear()
        driver.find_element_by_xpath('//div[@id="jumpDiv"]/input').send_keys(num)
        driver.find_element_by_id('jump').click()
        locator = (
            By.XPATH, '//ul[@id="info"]/li[1]/div[@class="title"]/a[not(contains(string(),"%s"))]' % val)
        WebDriverWait(driver, 20).until(EC.presence_of_element_located(locator))
    data = []
    page = driver.page_source
    body = etree.HTML(page)
    content_list = body.xpath("//ul[@id='info']/li")
    for content in content_list:
        name = content.xpath("./div[@class='title']/a/text()")[0].strip()
        li_onclick = content.xpath("./@onclick")[0].strip()
        ggstart_time = content.xpath("./div[@class='date']/text()")[0].strip()
        driver.find_element_by_xpath("//ul[@id='info']/li[contains(@onclick,'%s')]"%li_onclick).click()
        # url = "http://ggzyjy.liaoyang.gov.cn/"+content.xpath("./td/a/@href")[0].strip()
        windows = driver.window_handles
        driver.switch_to.window(windows[-1])
        WebDriverWait(driver,20).until(EC.visibility_of_all_elements_located((By.XPATH,"//div[@class='title']")))
        url = driver.current_url
        try:
            year = re.findall("GGZY/(\d+)/", url)[0][:4]
        except:
            year = "0000"
        driver.close()
        ggstart_time = year +"-" + ggstart_time
        temp = [name, ggstart_time, url]
        data.append(temp)
        # print(temp)
        windows = driver.window_handles
        try:
            driver.switch_to.window(windows[1])
            driver.close()
        except:
            pass
        driver.switch_to.window(windows[0])
    df = pd.DataFrame(data=data)
    df["info"] = None
    return df

def f2(driver):
    if "http://www.liaoyang.gov.cn/" in driver.current_url:
        locator = (By.XPATH,"//li[@class='no-active']/a")
        WebDriverWait(driver,20).until(EC.presence_of_element_located(locator))
        page_temp = driver.find_element_by_xpath("//li[@class='no-active']/a").text
        total_page = re.findall("\/(\d+)",page_temp)[0]
    else:
        if "00300100" in driver.current_url:
            locator = (By.ID, "zbggmore2_Pager")
            WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
            total_page = driver.find_element_by_xpath('//*[@id="zbggmore2_Pager"]/table/tbody/tr/td[1]/font[2]/b').text
        elif "00300200" in driver.current_url:
            locator = (By.ID, "zbgsmore2_Pager")
            WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
            total_page = driver.find_element_by_xpath('//*[@id="zbgsmore2_Pager"]/table/tbody/tr/td[1]/font[2]/b').text
        elif "00300300" in driver.current_url:
            locator = (By.ID, "zbjgmore2_Pager")
            WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
            total_page = driver.find_element_by_xpath('//*[@id="zbjgmore2_Pager"]/table/tbody/tr/td[1]/font[2]/b').text

    driver.quit()
    return int(total_page)

def f3(driver, url):
    driver.get(url)
    if "http://ggzyjy.liaoyang.gov.cn" in driver.current_url:
        locator = (By.CLASS_NAME, "colbor01")
        WebDriverWait(driver, 10).until(EC.presence_of_all_elements_located(locator))
        before = len(driver.page_source)
        time.sleep(0.1)
        after = len(driver.page_source)
        i = 0
        while before != after:
            before = len(driver.page_source)
            time.sleep(0.1)
            after = len(driver.page_source)
            i += 1
            if i > 5: break
        page = driver.page_source
        soup = BeautifulSoup(page, 'lxml')
        div = soup.find("div",class_="colbor01")
        return div

    else:
        locator = (By.ID, "tblInfo")
        WebDriverWait(driver, 10).until(EC.presence_of_all_elements_located(locator))
        before = len(driver.page_source)
        time.sleep(0.1)
        after = len(driver.page_source)
        i = 0
        while before != after:
            before = len(driver.page_source)
            time.sleep(0.1)
            after = len(driver.page_source)
            i += 1
            if i > 5: break
        page = driver.page_source
        soup = BeautifulSoup(page, 'lxml')
        div = soup.find('table', id='tblInfo')
        return div

data = [
    ["zfcg_zhaobiao_gg",
     "http://www.liaoyang.gov.cn/OpenData/opendata/ggzy/list/PurchaseList1.html",
     ["name", "ggstart_time", "href", "info"],f1, f2],
    ["zfcg_zhongbiao_gg",
     "http://www.liaoyang.gov.cn/OpenData/opendata/ggzy/list/PurchaseList4.html",
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["zfcg_biangen_gg",
     "http://www.liaoyang.gov.cn/OpenData/opendata/ggzy/list/PurchaseList2.html",
     ["name", "ggstart_time", "href", "info"], f1, f2],

    ["gcjs_zhaobiao_gg",
     "http://www.liaoyang.gov.cn/OpenData/opendata/ggzy/list/ConstructionList1.html",
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_zhongbiaohx_gg",
     "http://www.liaoyang.gov.cn/OpenData/opendata/ggzy/list/ConstructionList2.html",
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_zhongbiao_gg",
     "http://www.liaoyang.gov.cn/OpenData/opendata/ggzy/list/ConstructionList3.html",
     ["name", "ggstart_time", "href", "info"], f1, f2],


]


def work(conp,**args):
    est_meta(conp, data=data, diqu="辽宁省辽阳市",**args)
    est_html(conp, f=f3,**args)


if __name__ == "__main__":
    conp=["postgres", "since2015", "192.168.3.171", "liaoning", "liaoyang"]
    import sys
    arg=sys.argv
    if len(arg) >3:
        work(conp,num=int(arg[1]),total=int(arg[2]),html_total=int(arg[3]))
    elif len(arg) == 2:
        work(conp, html_total=int(arg[1]))
    else:
        work(conp)
