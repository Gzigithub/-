import json
import re
import time

from bs4 import BeautifulSoup
from lmfscrap import web
from lxml import etree
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import pandas as pd
from zhulong.util.etl import est_meta, est_html

_name_ = "nanjing"


def f1(driver, num):
    if "/067003/goverPurchase3" in driver.current_url:
        locator = (By.XPATH, "//div[@data-role='tab-content']//li[@class='ewb-info-item2 clearfix']")
        WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
        html = driver.page_source
        body = etree.HTML(html)
        content_list = body.xpath(
            "//div[@data-role='tab-content']//ul[@class='ewb-info-items']/li[@class='ewb-info-item2 clearfix']")
    elif "goods" not in driver.current_url and "069003" not in driver.current_url:
        locator = (
            By.XPATH, "//div[@data-role='tab-content' and @class='']//li[@class='ewb-info-item2 clearfix']")
        WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
        val = driver.find_element_by_xpath(
            "//div[@data-role='tab-content' and @class='']//li[1]/div[1]/p").text
        cnum = \
            driver.find_element_by_xpath("//div[@data-role='tab-content' and @class='']//li/a/span").text.split(
                '/')[0]
        if num != cnum and num != 1:
            driver.find_element_by_xpath(
                "//div[@data-role='tab-content' and @class='']//input[@class='wb-page-item']").clear()
            driver.find_element_by_xpath(
                "//div[@data-role='tab-content' and @class='']//input[@class='wb-page-item']").send_keys(num)
            driver.find_element_by_xpath(
                "//div[@data-role='tab-content' and @class='']//a[@class='wb-page-item wb-page-next wb-page-go wb-page-fs12']").click()
            locator = (
                By.XPATH,
                "//div[@data-role='tab-content' and @class='']//li[1]/div[1]/p[string() != '%s']" % val)
            WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
        locator = (
            By.XPATH, "//div[@data-role='tab-content' and @class='']//li[@class='ewb-info-item2 clearfix']")
        WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))

        html = driver.page_source
        body = etree.HTML(html)
        content_list = body.xpath(
            "//div[@data-role='tab-content' and @class='']//ul[@class='ewb-info-items']/li[@class='ewb-info-item2 clearfix']")
    else:
        locator = (By.XPATH, "//div[@data-role='tab-content']//li[@class='ewb-info-item2 clearfix'][1]")
        WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
        val = driver.find_element_by_xpath(
            "//div[@data-role='tab-content']//ul[@class='ewb-info-items']/li[1]/div/p").text
        cnum = driver.find_element_by_xpath("//div[@data-role='tab-content']//li/a/span").text.split('/')[0]
        if num != cnum:
            driver.find_element_by_xpath(
                "//div[@data-role='tab-content']//input[@class='wb-page-item']").clear()
            driver.find_element_by_xpath(
                "//div[@data-role='tab-content']//input[@class='wb-page-item']").send_keys(num)
            driver.find_element_by_xpath(
                "//div[@data-role='tab-content']//a[@class='wb-page-item wb-page-next wb-page-go wb-page-fs12']").click()
            locator = (By.XPATH,
                       "//div[@data-role='tab-content']//ul[@class='ewb-info-items']/li[1]/div/p[not(contains(string(),'%s'))]" % val)
            WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
        html = driver.page_source
        body = etree.HTML(html)
        content_list = body.xpath(
            "//div[@data-role='tab-content' and @class='']//ul[@class='ewb-info-items']/li[@class='ewb-info-item2 clearfix']")
    data = []
    for l in content_list[:10]:
        n = l.xpath("./div/p")
        if len(n) == 6:
            n.pop()
        lenth = int(len(n))
        if lenth > 2:
            name = ""
            for i in range(lenth - 2):
                if n[i] == None:
                    name += " "
                else:
                    name += n[i].text + " "
        else:
            name = l.xpath("./div/p")[0].text
        ggstart_time = l.xpath("./div/p")[-1].text
        if type(ggstart_time) != type('x') or ggstart_time.strip() == '':
            ggstart_time = '0000-00-0000'
        url = l.xpath("./@onclick")[0]
        new_url = '/'.join(driver.current_url.split('/')[:3]) + re.findall('[\.\w].*?\'([\.\/\w].*?)\'', url)[0]
        temp = [name, ggstart_time, new_url]
        data.append(temp)
    df = pd.DataFrame(data=data)
    try:
        info = driver.find_element_by_xpath("//span[@class='ewb-comp-tt l current']/a").text
        tem = {"type": info}
        df["info"] = json.dumps(tem, ensure_ascii=False)
    except:
        df["info"] = None
    return df


def f2(driver):
    if "/067003/goverPurchase3" in driver.current_url:
        page = 1
    elif "goods" not in driver.current_url and "069003" not in driver.current_url:
        locator = (By.XPATH, "//div[@data-role='tab-content' and @class='']//li[1]/div[1]/p")
        WebDriverWait(driver, 20).until(EC.presence_of_element_located(locator))
        page = int(
            driver.find_element_by_xpath("//div[@data-role='tab-content' and @class='']//a/span").text.split('/')[1])
    else:
        locator = (By.XPATH, "//div[@data-role='tab-content']//li[1]/div[1]/p")
        WebDriverWait(driver, 20).until(EC.presence_of_element_located(locator))
        page = int(
            driver.find_element_by_xpath("//div[@data-role='tab-content']//a/span").text.split('/')[
                1])
    driver.quit()
    return page


def f3(driver, url):
    driver.get(url)
    locator = (By.CLASS_NAME, "article-info")
    WebDriverWait(driver, 10).until(EC.presence_of_all_elements_located(locator))
    before = len(driver.page_source)
    time.sleep(0.1)
    after = len(driver.page_source)
    i = 0
    while before != after:
        before = len(driver.page_source)
        time.sleep(0.1)
        after = len(driver.page_source)
        i += 1
        if i > 5: break
    page = driver.page_source
    soup = BeautifulSoup(page, 'html.parser')
    div = soup.find('div', class_='article-info')
    return div


def switch(driver, ggtype):
    locator = (By.XPATH, "//div[@class='ewb-comp-hd clearfix']/span/a")
    WebDriverWait(driver, 20).until(EC.presence_of_all_elements_located(locator))
    driver.find_element_by_xpath(
        "//div[@class='ewb-comp-hd clearfix']/span/a[contains(string(),'%s')]" % ggtype).click()
    # time.sleep(2)


def before(f, ggtype):
    def wrap(*arg):
        driver = arg[0]
        switch(driver, ggtype)
        return f(*arg)

    return wrap


data = [
    # # 房建市政
    ["gcjs_fangwushizheng_zhaobiao_fw_gg", "http://ggzy.njzwfw.gov.cn/njweb/fjsz/buildService1.html",
     ["name", "ggstart_time", "href", "info"], f1, f2, ],
    ["gcjs_fangwushizheng_zhaobiao_gc_gg", "http://ggzy.njzwfw.gov.cn/njweb/fjsz/buildService1.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "工程类"), before(f2, "工程类")],
    ["gcjs_fangwushizheng_zhaobiao_xxgc_gg", "http://ggzy.njzwfw.gov.cn/njweb/fjsz/buildService1.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "小型工程"), before(f2, "小型工程")],

    ["gcjs_fangwushizheng_zhongbiaohx_gc_gg", "http://ggzy.njzwfw.gov.cn/njweb/fjsz/068002/buildService2.html",
     ["name", "ggstart_time", "href", "info"], f1, f2, ],
    ["gcjs_fangwushizheng_zhongbiaohx_fw_gg", "http://ggzy.njzwfw.gov.cn/njweb/fjsz/068002/buildService2.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "服务类"), before(f2, "服务类")],
    #
    ["gcjs_fangwushizheng_zhongbiao_fw_gg", "http://ggzy.njzwfw.gov.cn/njweb/fjsz/068003/buildService3.html",
     ["name", "ggstart_time", "href", "info"], f1, f2, ],
    ["gcjs_fangwushizheng_zhongbiao_gc_gg", "http://ggzy.njzwfw.gov.cn/njweb/fjsz/068003/buildService3.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "工程类"), before(f2, "工程类")],
    ["gcjs_fangwushizheng_zhongbiao_xxgc_gg", "http://ggzy.njzwfw.gov.cn/njweb/fjsz/068003/buildService3.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "小型工程"), before(f2, "小型工程")],
    #
    ["gcjs_fangwushizheng_liubiao_gg", "http://ggzy.njzwfw.gov.cn/njweb/fjsz/068005/buildService5.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "两次不足三家"), before(f2, "两次不足三家")],
    ["gcjs_fangwushizheng_zishenjieguo_gg", "http://ggzy.njzwfw.gov.cn/njweb/fjsz/068005/buildService5.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "资审未通过"), before(f2, "资审未通过")],
    # # 工程货物
    ["gcjs_gongchenghuowu_zhaobiao_gg", "http://ggzy.njzwfw.gov.cn/njweb/gchw/goods.html",
     ["name", "ggstart_time", "href", "info"], f1, f2, ],
    ["gcjs_gongchenghuowu_zhongbiaohx_gg", "http://ggzy.njzwfw.gov.cn/njweb/gchw/070003/goods3.html",
     ["name", "ggstart_time", "href", "info"], f1, f2, ],
    ["gcjs_gongchenghuowu_zhongbiao_gg", "http://ggzy.njzwfw.gov.cn/njweb/gchw/070004/goods4.html",
     ["name", "ggstart_time", "href", "info"], f1, f2, ],
    # # # 交通水利
    ["gcjs_jiaotong_zhaobiao_shigong_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/traffic.html",
     ["name", "ggstart_time", "href", "info"], f1, f2, ],
    ["gcjs_jiaotong_zhaobiao_jianli_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/traffic.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "监理"), before(f2, "监理")],
    ["gcjs_jiaotong_zhaobiao_kanchasheji_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/traffic.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "勘察设计"), before(f2, "勘察设计")],
    ["gcjs_jiaotong_zhaobiao_cailiaocaigou_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/traffic.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "材料采购"), before(f2, "材料采购")],
    ["gcjs_jiaotong_zhaobiao_shiyanjiance_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/traffic.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "试验检测"), before(f2, "试验检测")],
    ["gcjs_jiaotong_zhongbiao_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/069003/traffic3.html",
     ["name", "ggstart_time", "href", "info"], f1, f2, ],
    #
    ["gcjs_shuili_zhaobiao_gc_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/069005/traffic5.html",
     ["name", "ggstart_time", "href", "info"], f1, f2, ],
    ["gcjs_shuili_zhaobiao_fw_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/069005/traffic5.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "服务类"), before(f2, "服务类")],
    ["gcjs_shuili_zhaobiao_hw_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/069005/traffic5.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "货物类"), before(f2, "货物类")],
    ["gcjs_shuili_zhongbiao_gc_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/069006/traffic6.html",
     ["name", "ggstart_time", "href", "info"], f1, f2, ],
    ["gcjs_shuili_zhongbiao_fw_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/069006/traffic6.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "服务类"), before(f2, "服务类")],
    ["gcjs_shuili_zhongbiao_hw_gg", "http://ggzy.njzwfw.gov.cn/njweb/jtsw/069006/traffic6.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "货物类"), before(f2, "货物类")],
    #
    # 政府采购
    # 特殊页面
    #
    ["zfcg_zhaobiao_gg", "http://ggzy.njzwfw.gov.cn/njweb/zfcg/goverPurchase.html",
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["zfcg_zhaobiao_biangen_gg", "http://ggzy.njzwfw.gov.cn/njweb/zfcg/goverPurchase.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "更正公告"), before(f2, "更正公告")],

    ["zfcg_zishenjieguo_gg", "http://ggzy.njzwfw.gov.cn/njweb/zfcg/067003/goverPurchase3.html",
     ["name", "ggstart_time", "href", "info"], f1, f2],

    ["zfcg_zhongbiao_gg", "http://ggzy.njzwfw.gov.cn/njweb/zfcg/067002/goverPurchase2.html",
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["zfcg_zhongbiao_biangen_gg", "http://ggzy.njzwfw.gov.cn/njweb/zfcg/067002/goverPurchase2.html",
     ["name", "ggstart_time", "href", "info"], before(f1, "更正公告"), before(f2, "更正公告")],

]


def work(conp, **kwargs):
    est_meta(conp, data=data, diqu="江苏省南京市", **kwargs)
    est_html(conp, f=f3, **kwargs)


if __name__ == "__main__":
    conp=["postgres", "since2015", "192.168.3.171", "jiangsu", "nanjing"]
    import sys
    arg=sys.argv
    if len(arg) >3:
        work(conp,num=int(arg[1]),total=int(arg[2]),html_total=int(arg[3]))
    elif len(arg) == 2:
        work(conp, html_total=int(arg[1]))
    else:
        work(conp)
