import json
import re
from bs4 import BeautifulSoup
from lmfscrap import web
from lxml import etree
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import pandas as pd
from zhulong.util.etl import est_html, est_meta
import requests
import time

_name_ = 'suzhou'
def f3(driver, url):
    driver.get(url)
    if "tblInfo" in driver.page_source:
        locator = (By.ID, "tblInfo")
        WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
    elif "panel" in driver.page_source:
        locator = (By.CLASS_NAME, "panel")
        WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
    elif "lxwm_td" in driver.page_source:
        locator = (By.XPATH,'//*[@id="lxwm_td"]/table/tbody/tr[2]/td[2]/table/tbody/tr[3]/td/table/tbody/tr[2]/td')
        WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
    else:
        locator = (By.XPATH,'//*[@id="body"]')
        WebDriverWait(driver, 20).until(EC.presence_of_element_located(locator))
    before = len(driver.page_source)
    time.sleep(0.1)
    after = len(driver.page_source)
    i = 0
    while before != after:
        before = len(driver.page_source)
        time.sleep(0.1)
        after = len(driver.page_source)
        i += 1
        if i > 5: break

    page = driver.page_source
    soup = BeautifulSoup(page, 'html.parser')

    if driver.page_source.find("tblInfo") != -1:
        div = soup.find('table', id='tblInfo')
    elif driver.page_source.find("panel") != -1:
        div = soup.find('table', class_='panel')
    elif driver.page_source.find("lxwm_td") != -1:
        table = soup.find('table',class_='bxx')
        tbody1 = table.find('tbody')
        tbody2 = tbody1.find('tbody')
        div = tbody2.find('tbody')
    else:
        div = soup.find('div', id='body')
    # print(div)
    return div


def f1(driver, num):
    if "00200400" not in driver.current_url:
        if driver.page_source.find("iframe") != -1:
            iframe = driver.find_element_by_css_selector("iframe")
            driver.switch_to_frame(iframe)
        if "zbgg" in driver.current_url:
            type = "zbgg"
        elif "zgxj" in driver.current_url:
            type = "zgxj"
        elif "zbgs" in driver.current_url:
            type = "zbgs"
        elif "jsgc" in driver.current_url:
            type = "jsgc"
        else:
            type = "jsgc"

        if "jyzx" not in driver.current_url:
            locator = (By.XPATH, '//*[@id="moreinfo_'+type+'1_DataGrid1"]/tbody/tr[1]//font')
            WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
            val = driver.find_element_by_xpath('//*[@id="moreinfo_'+type+'1_DataGrid1"]/tbody/tr[2]/td/a').get_attribute("href")[-50:]
            locator = (By.CLASS_NAME, 'huifont')
            WebDriverWait(driver, 20).until(EC.visibility_of_all_elements_located(locator))
            cnum = driver.find_element_by_class_name('huifont').text.split('/')[0]
            if int(cnum) != int(num):
                driver.find_element_by_id("GoToPagingNo").clear()
                driver.find_element_by_id("GoToPagingNo").send_keys(num)
                driver.find_element_by_class_name("goout").click()

                locator = (By.XPATH, '//*[@id="moreinfo_'+type+'1_DataGrid1"]/tbody/tr[1]//font[not(contains(@href,"%s"))]' %val)
                WebDriverWait(driver, 30).until(EC.visibility_of_element_located(locator))
            locator = (By.XPATH, '//*[@id="moreinfo_'+type+'1_DataGrid1"]/tbody//tr')
            WebDriverWait(driver, 30).until(EC.visibility_of_all_elements_located(locator))
            data = []
            page = driver.page_source
            body = etree.HTML(page)
            content_list = body.xpath('//*[@id="moreinfo_'+type+'1_DataGrid1"]/tbody//tr')

            for content in content_list:
                name = content.xpath("./td/a/font/text()")[0].strip()
                ggstart_time = content.xpath("./td[4]/text()")[0].strip()
                url = "http://szzyjy.fwzx.suzhou.gov.cn" + content.xpath("./td/a/@href")[0]
                temp = [name, ggstart_time, url]
                data.append(temp)
            df = pd.DataFrame(data=data)
            df['info'] = None
            return df
        else:
            locator = (By.XPATH, '//*[@id="moreinfo_'+type+'1_DataGrid1"]/tbody//font')
            WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
            val = driver.find_element_by_xpath('//*[@id="moreinfo_'+type+'1_DataGrid1"]/tbody//font').text
            locator = (By.CLASS_NAME, 'huifont')
            WebDriverWait(driver, 20).until(EC.visibility_of_all_elements_located(locator))
            cnum = driver.find_element_by_class_name('huifont').text.split('/')[0]
            if int(cnum) != int(num):
                driver.find_element_by_id("GoToPagingNo").clear()
                driver.find_element_by_id("GoToPagingNo").send_keys(num)
                driver.find_element_by_class_name("goout").click()

                locator = (By.XPATH, '//*[@id="moreinfo_'+type+'1_DataGrid1"]/tbody//font[not(contains(string(),"%s"))]' % val)
                WebDriverWait(driver, 30).until(EC.visibility_of_element_located(locator))
            locator =(By.XPATH,'//*[@id="moreinfo_'+type+'1_DataGrid1"]/tbody//tr')
            WebDriverWait(driver,30).until(EC.visibility_of_all_elements_located(locator))
            data = []
            page = driver.page_source
            body = etree.HTML(page)
            content_list = body.xpath('//*[@id="moreinfo_'+type+'1_DataGrid1"]/tbody//tr')[1:]

            for content in content_list:
                name = content.xpath("./td/a/font/text()")[0].strip()
                if "zbgs" in driver.current_url:
                    ggstart_time = '0000-00-00'
                else:
                    ggstart_time = content.xpath("./td[5]/text()")[0].strip()
                url = "http://szzyjy.fwzx.suzhou.gov.cn" + content.xpath("./td/a/@href")[0]
                temp = [name, ggstart_time, url]
                data.append(temp)
            df = pd.DataFrame(data=data)
            if "zbgs" in driver.current_url:
                time_temp = {"ggstart_time": "网页无时间"}
                df["info"] = json.dumps(time_temp)
            else:
                df['info'] = None
            return df

    else:
        locator = (By.XPATH, "//div[@class='mr-content']//tr[1]//a")
        WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
        val = driver.find_element_by_xpath("//div[@class='mr-content']//tr[1]//a").text
        locator = (By.CLASS_NAME, 'huifont')
        WebDriverWait(driver, 20).until(EC.visibility_of_all_elements_located(locator))
        cnum = driver.find_element_by_class_name('huifont').text.split('/')[0]
        if int(cnum) != int(num):
            driver.execute_script("window.location.href='./?Paging=%s'"%num)
            locator = (
            By.XPATH, '//div[@class="mr-content"]//tr[1]//a[not(contains(string(),"%s"))]' % val)
            WebDriverWait(driver, 30).until(EC.visibility_of_element_located(locator))
        locator = (By.XPATH, "//div[@class='mr-content']//tr")
        WebDriverWait(driver, 30).until(EC.visibility_of_all_elements_located(locator))
        data = []
        page = driver.page_source
        body = etree.HTML(page)
        content_list = body.xpath("//div[@class='mr-content']/div/table/tbody/tr")
        for content in content_list:
            name = content.xpath("./td/a/@title")[0].strip()
            ggstart_time = content.xpath("./td[@align='right']/text()")[0].strip()
            url = "http://szzyjy.fwzx.suzhou.gov.cn"+content.xpath("./td/a/@href")[0].strip()
            temp = [name, ggstart_time, url]
            data.append(temp)
            # print(temp)
        df = pd.DataFrame(data=data)
        df['info'] = None
        return df



def f2(driver):
    if "00200400" not in driver.current_url:
        if driver.page_source.find("iframe") != -1:
            iframe = driver.find_element_by_css_selector("iframe")
            driver.switch_to_frame(iframe)
    locator = (By.CLASS_NAME, 'huifont')
    WebDriverWait(driver, 20).until(EC.visibility_of_element_located(locator))
    total_page = int(driver.find_element_by_class_name('huifont').text.split('/')[1])
    driver.quit()
    return total_page


data = [
    ["gcjs_zhaobiao_gg", "http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jyzx_zbgg.aspx?CategoryNum=002001001",  #//*[@id="moreinfo_zbgg1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_kongzhijia_gg", "http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jyzx_zgxj.aspx?CategoryNum=002001003",# //*[@id="moreinfo_zgxj1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_zhongbiaohx_gg", "http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jyzx_zgxj.aspx?CategoryNum=002001005",# //*[@id="moreinfo_zgxj1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_zhongbiao_gg", "http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jyzx_zbgs.aspx?CategoryNum=002001006", #//*[@id="moreinfo_zbgs1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_biangen_gg", "http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jyzx_zgxj.aspx?CategoryNum=002001007",  #//*[@id="moreinfo_zgxj1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],

    ["gcjs_jiaotong_zhaobiao_gg", "http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jsgc_search.aspx?CategoryNum=002002002", #//*[@id="moreinfo_jsgc1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_jiaotong_zhongbiao_gg","http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jsgc_search.aspx?CategoryNum=002002004",#//*[@id="moreinfo_jsgc1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_jiaotong_zhongbiaohx_gg","http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jsgc_search.aspx?CategoryNum=002002003",#//*[@id="moreinfo_jsgc1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],


    ["gcjs_shuili_kongzhijia_gg", "http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jsgc_search.aspx?CategoryNum=002003003",#//*[@id="moreinfo_jsgc1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_shuili_zhaobiao_gg", "http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jsgc_search.aspx?CategoryNum=002003001",#//*[@id="moreinfo_jsgc1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_shuili_zhongbiaohx_gg", "http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jsgc_search.aspx?CategoryNum=002003006",#//*[@id="moreinfo_jsgc1_DataGrid1"]
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["gcjs_shuili_zhongbiao_gg",
     "http://szzyjy.fwzx.suzhou.gov.cn/Front/ShowInfo/jsgc_search.aspx?CategoryNum=002003005",
     ["name", "ggstart_time", "href", "info"], f1, f2],

    ["zfcg_zhaobiao_gg",
     "http://szzyjy.fwzx.suzhou.gov.cn/Front/jyzx/002004/002004001/",
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["zfcg_zhongbiao_gg",
     "http://szzyjy.fwzx.suzhou.gov.cn/Front/jyzx/002004/002004002/",
     ["name", "ggstart_time", "href", "info"], f1, f2],
    ["zfcg_biangeng_gg",
     "http://szzyjy.fwzx.suzhou.gov.cn/Front/jyzx/002004/002004003/",
     ["name", "ggstart_time", "href", "info"], f1, f2],

]


def work(conp,**kwargs):
    est_meta(conp, data=data, diqu="江苏省苏州市",**kwargs)
    est_html(conp, f=f3,**kwargs)


if __name__ == "__main__":
    conp=["postgres", "since2015", "192.168.3.171", "jiangsu", "suzhou"]
    import sys
    arg=sys.argv
    if len(arg) >3:
        work(conp,num=int(arg[1]),total=int(arg[2]),html_total=int(arg[3]))
    elif len(arg) == 2:
        work(conp, html_total=int(arg[1]))
    else:
        work(conp)